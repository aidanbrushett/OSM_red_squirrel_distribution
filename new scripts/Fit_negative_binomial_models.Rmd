---
title: "Submodels and final models"
author: "Emerald Arthurs and Aidan Brushett"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: default
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      paged.print=TRUE)
```

# 0. Before you begin

Emerald Arthurs
M.Sc. Student
University of Victoria    
School of Environmental Studies     
Email: [emeraldarthurs@uvic.ca](emeraldarthurs@uvic.ca)

Aidan Brushett
M.Sc. Student
University of Victoria    
School of Environmental Studies     
Email: [aidanbrushett@uvic.ca](aidanbrushett@uvic.ca)

***

# 0. Setup

```{r libraries, message=FALSE, warning=FALSE}
rm(list = ls())
#library(MASS)
library(glmmTMB)
#library(lme4)
library(tidyverse)
library(MuMIn)
library(rphylopic)
library(corrr)
library(performance)
library(PerformanceAnalytics)

#`%nin%` <- Negate(`%in%`)
```

# 1. Import data

We will also apply standardized z-scaling to the data. This is done *per buffer* since technically they are different datasets. 

```{r data for modelling}
covs <- read_csv("./data/processed/OSM_all_covariates_HFI_SBFI_final.csv")

response <- read_csv("./data/processed/OSM_monthly_detections_2021_2022_2023.csv") %>%
  
  filter(species == "red squirrel") %>%
  
  select(-species, -presence) %>%
  
  rename(squirrel = detections)


data <- response %>%
  
  left_join(covs, by = c("array", "site"))

# Make sure there are 20 rows per site/month/year 
data %>% 
  
  group_by(site, month, year) %>%
  
  summarize(n_obs = n()) %>%
  
  arrange(n_obs)
# 20 for everything. Looks good!!

data_scaled <- data %>%
  
  group_by(buffer_dist) %>%
  
  mutate(across(cfi_site:last_col(), ~ as.numeric(scale(.)))) %>%
  
  ungroup(.)

# The mean will be 0 even though we grouped first, since the mean for each buffer is still 0. 
summary(data_scaled)
```

# 2. Determine core model

```{r}
names(data)
```

First, let's try using landcover instead of tree composition first. 

```{r}
core_models <- purrr::map(unique(data$buffer_dist), ~{
  
  cat("\r\r Fitting models at scale:", .x, "meters      ")

  data_subset <- data_scaled %>%
    
    filter(buffer_dist == .x)
  
  m_null <- glmmTMB(squirrel ~ 
                        
                        #lc_coniferous + 
                        #lc_mixedwood + 
                        #lc_broadleaf + 
                        #lc_shrubs +
                        #lc_herbs +
                        #fire_0_15 + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_fire <- glmmTMB(squirrel ~ 
                        
                        #lc_coniferous + 
                        #lc_mixedwood + 
                        #lc_broadleaf + 
                        #lc_shrubs +
                        #lc_herbs +
                        fire_0_15 + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  
  m_forest <- glmmTMB(squirrel ~ 
                        
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        #lc_shrubs +
                        #lc_herbs +
                        #fire_0_15 + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_forest_fire <- glmmTMB(squirrel ~ 
                        
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf +
                        #lc_shrubs +
                        #lc_herbs +
                        fire_0_15 + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  
  m_landcover <- glmmTMB(squirrel ~ 
                        
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        lc_shrubs +
                        lc_wetland +
                        lc_wetland_treed + 
                        #fire_0_15 + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_landcover_fire <- glmmTMB(squirrel ~ 
                        
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        lc_shrubs +
                        lc_wetland +
                        lc_wetland_treed + 
                        fire_0_15 + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  MuMIn::model.sel(m_null, m_fire, m_forest, m_forest_fire, m_landcover, m_landcover_fire) %>%
  
    as.data.frame(.) %>%
    
    select(-`disp((Int))`) %>%
  
    rename_with(~ gsub("cond\\(|disp\\(|\\)|\\(", "", .)) %>%
    
    rename(intercept = `Int`) %>%
    
    mutate(model_name = rownames(.),
           buffer_dist = .x) %>%
    
    rename(delta_subset = delta)

  }
  ) %>%
  
  bind_rows(.) %>%
  
  mutate(delta = AICc - min(AICc)) %>%
  
  arrange(delta)
```

We could also re-produce this process using tree species instead of landcover

```{r}
core_models_spp <- purrr::map(unique(data$buffer_dist), ~{
  
  cat("\r\r Fitting models at scale:", .x, "meters      ")

  data_subset <- data_scaled %>%
    
    filter(buffer_dist == .x)
  
  m_null <- glmmTMB(squirrel ~ 
                        
                        #pct_pinu_ban +
                        #pct_pice_mar +
                        #pct_pice_gla +
                        #pct_popu_tre +
                        #pct_lari_lar +
                        #fire_0_15 +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_fire <- glmmTMB(squirrel ~ 
                        
                        #pct_pinu_ban +
                        #pct_pice_mar +
                        #pct_pice_gla +
                        #pct_popu_tre +
                        #pct_lari_lar +
                        fire_0_15 +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  
  m_conifspp <- glmmTMB(squirrel ~ 
                        
                        pct_pinu_ban +
                        pct_pice_mar +
                        pct_pice_gla +
                        #pct_popu_tre +
                        #pct_lari_lar +
                        #fire_0_15 +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_conifspp_fire <- glmmTMB(squirrel ~ 
                        
                        pct_pinu_ban +
                        pct_pice_mar +
                        pct_pice_gla +
                        #pct_popu_tre +
                        #pct_lari_lar +
                        fire_0_15 +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  
  m_allspp <- glmmTMB(squirrel ~ 
                        
                        pct_pinu_ban +
                        pct_pice_mar +
                        pct_pice_gla +
                        pct_popu_tre +
                        pct_lari_lar +
                        #fire_0_15 +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_allspp_fire <- glmmTMB(squirrel ~ 
                        
                        pct_pinu_ban +
                        pct_pice_mar +
                        pct_pice_gla +
                        pct_popu_tre +
                        pct_lari_lar +
                        fire_0_15 +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  MuMIn::model.sel(m_null, m_fire, m_conifspp, m_conifspp_fire, m_allspp, m_allspp_fire) %>%
  
    as.data.frame(.) %>%
    
    select(-`disp((Int))`) %>%
  
    rename_with(~ gsub("cond\\(|disp\\(|\\)|\\(", "", .)) %>%
    
    rename(intercept = `Int`) %>%
    
    mutate(model_name = rownames(.),
           buffer_dist = .x) %>%
    
    rename(delta_subset = delta)

  }
  ) %>%
  
  bind_rows(.) %>%
  
  mutate(delta = AICc - min(AICc)) %>%
  
  arrange(delta)
```

What are the top predictors and top spatial scale for our natural covariates?

```{r}
core_predictors <- core_models %>%
  
  select(1:which(names(.) == "df") - 1, -intercept) %>% 
  
  filter(row_number()==1) %>%
  
  select(where(~ !is.na(.))) %>%  # Remove columns with NA values

  colnames(.)
  
core_buffer <- core_models$buffer_dist[1]

core_predictors
core_buffer
```
# 2. Composition models

```{r}
comp_models <- purrr::map(unique(data$buffer_dist), ~{
  
  cat("\r\r Fitting models at scale:", .x, "meters      ")

  data_subset <- data_scaled %>%
    
    filter(buffer_dist == .x)
  
  m_null <- glmmTMB(squirrel ~ 
                        #lc_coniferous + 
                        #lc_mixedwood + 
                        #lc_broadleaf + 
                        #fire_0_15 + 

                        #pipe_trans + 
                        #seismic + 
                        #wells_inactive + 
                        #harvest_total +
                        #wells_active +
                        #osm_industrial +
                        #harvest_0_15
                        #roads +
                        
                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_core <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 

                        #pipe_trans + 
                        #seismic + 
                        #wells_inactive + 
                        #harvest_total +
                        #wells_active +
                        #osm_industrial +
                        #harvest_0_15
                        #roads +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_seis_wells <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 
                          
                        pipe_trans + 
                        seismic + 
                        wells_inactive + 
                        #harvest_total +
                        #wells_active +
                        #osm_industrial +
                        #harvest_0_15 +
                        #roads + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_harvest <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 
                         
                        #pipe_trans + 
                        #seismic + 
                        #wells_inactive + 
                        #harvest_total +
                        #wells_active +
                        #osm_industrial +
                        harvest_0_15 +
                        #roads + + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_harvest_seis <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 
                              
                        pipe_trans + 
                        seismic + 
                        wells_inactive + 
                        #harvest_total +
                        #wells_active +
                        #osm_industrial +
                        harvest_0_15 +
                        #roads + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  
  m_active <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 
                        
                        #pipe_trans + 
                        #seismic + 
                        #wells_inactive + 
                        #harvest_total +
                        wells_active +
                        osm_industrial +
                        #harvest_0_15 +
                        #roads + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_active_harvest <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 
                          
                        #pipe_trans + 
                        #seismic + 
                        #wells_inactive + 
                        #harvest_total +
                        wells_active +
                        osm_industrial +
                        harvest_0_15 +
                        #roads + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_active_seis <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 
                        
                        pipe_trans + 
                        seismic + 
                        wells_inactive + 
                        #harvest_total +
                        wells_active +
                        osm_industrial +
                        #harvest_0_15 +
                        #roads + 
                          
                      (1|array/site),
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)

  m_global <- glmmTMB(squirrel ~ 
                        lc_coniferous + 
                        lc_mixedwood + 
                        lc_broadleaf + 
                        fire_0_15 + 
                        
                        pipe_trans + 
                        seismic + 
                        wells_inactive + 
                        #harvest_total +
                        wells_active +
                        osm_industrial +
                        harvest_0_15 +
                        #roads + 

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  MuMIn::model.sel(m_null, m_core, m_seis_wells, m_harvest, m_harvest_seis, m_active_seis, m_active, m_active_harvest, m_global) %>%
  
    as.data.frame(.) %>%
    
    select(-`disp((Int))`) %>%
  
    rename_with(~ gsub("cond\\(|disp\\(|\\)|\\(", "", .)) %>%
    
    rename(intercept = `Int`) %>%
    
    mutate(model_name = rownames(.),
           buffer_dist = .x) %>%
    
    rename(delta_subset = delta)

  }
  ) %>%
  
  bind_rows(.) %>%
  
  mutate(delta = AICc - min(AICc)) %>%
  
  arrange(delta)
```

What are the top predictors and top spatial scale for our natural covariates?

```{r}
comp_predictors <- comp_models %>%
  
  select(1:which(names(.) == "df") - 1, -intercept) %>% 
  
  filter(row_number()==1) %>%
  
  select(where(~ !is.na(.))) %>%  # Remove columns with NA values

  colnames(.)
  
comp_buffer <- comp_models$buffer_dist[1]

comp_predictors
comp_buffer
```


# 3. Configuration models

Let's fit the configuration models

```{r}
config_models <- purrr::map(unique(data$buffer_dist), ~{
  
  cat("\r\r Fitting models at scale:", .x, "meters      ")

  data_subset <- data_scaled %>%
    
    filter(buffer_dist == .x)
  
  m_null <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        #fire_0_15 +
                        #lc_broadleaf +
                        #lc_coniferous +
                        #lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        #nonanthro_ed + 
                        #landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_core <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        #nonanthro_ed + 
                        #landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  
  m_het <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        landscape_shei +
                        #nonanthro_ed + 
                        #landscape_mesh +
                         
                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_edge <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        nonanthro_ed + 
                        #landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
                    
  m_conn <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        #nonanthro_ed + 
                        landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_edge_conn <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood +
                      
                        # configuration variables
                        #landscape_shei +
                        nonanthro_ed + 
                        landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)

  m_het_conn <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        landscape_shei +
                        #nonanthro_ed + 
                        landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
    
  m_het_edge <- glmmTMB(squirrel ~
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood +
                      
                        # configuration variables
                        landscape_shei +
                        nonanthro_ed +
                        #landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_config <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood +
                      
                        # configuration variables
                        landscape_shei +
                        nonanthro_ed +
                        landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)

  
  MuMIn::model.sel(m_null, m_core, m_edge, m_het, m_conn, m_het_edge, m_edge_conn, m_het_conn, m_config) %>%
  
    as.data.frame(.) %>%
    
    select(-`disp((Int))`) %>%
  
    rename_with(~ gsub("cond\\(|disp\\(|\\)|\\(", "", .)) %>%
    
    rename(intercept = `Int`) %>%
    
    mutate(model_name = rownames(.),
           buffer_dist = .x) %>%
    
    rename(delta_subset = delta)

  }
  ) %>%
  
  bind_rows(.) %>%
  
  mutate(delta = AICc - min(AICc)) %>%
  
  arrange(delta)
```

What are the top predictors and top spatial scale for our configuration covariates?

```{r}
config_predictors <- config_models %>%
  
  select(1:which(names(.) == "df") - 1, -intercept) %>% 
  
  filter(row_number()==1) %>%
  
  select(where(~ !is.na(.))) %>%  # Remove columns with NA values

  colnames(.)
  
config_buffer <- config_models$buffer_dist[1]

config_predictors
config_buffer
```

# 3B. Configuration interaction models

```{r}
config_int_models <- purrr::map(unique(data$buffer_dist), ~{
  
  cat("\r\r Fitting models at scale:", .x, "meters      ")

  data_subset <- data_scaled %>%
    
    filter(buffer_dist == .x)
  
  m_null <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        #fire_0_15 +
                        #lc_broadleaf +
                        #lc_coniferous +
                        #lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        #nonanthro_ed + 
                        #landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_core <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        #nonanthro_ed + 
                        #landscape_mesh +

                        (1|array/site),
                      
                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_edge <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        nonanthro_ed + 
                        #landscape_mesh +

                        (1|array/site),

                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_edge_cfi <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        nonanthro_ed + 
                        cfi_site_with_vegedges +
                        #landscape_mesh +

                        (1|array/site),

                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)
  
  m_edgeXcfi <- glmmTMB(squirrel ~ 
                        
                        # natural covariates
                        fire_0_15 +
                        lc_broadleaf +
                        lc_coniferous +
                        lc_mixedwood + 
                      
                        # configuration variables
                        #landscape_shei +
                        nonanthro_ed + 
                        cfi_site_with_vegedges +
                        nonanthro_ed*cfi_site_with_vegedges +
                        #landscape_mesh +

                        (1|array/site),

                      data = data_subset, 
                      family = nbinom2, 
                      na.action = na.fail)

  MuMIn::model.sel(m_null, m_core, m_edge, m_edge_cfi, m_edgeXcfi) %>%
  
    as.data.frame(.) %>%
    
    select(-`disp((Int))`) %>%
  
    rename_with(~ gsub("cond\\(|disp\\(|\\)|\\(", "", .)) %>%
    
    rename(intercept = `Int`) %>%
    
    mutate(model_name = rownames(.),
           buffer_dist = .x) %>%
    
    rename(delta_subset = delta)

  }
  ) %>%
  
  bind_rows(.) %>%
  
  mutate(delta = AICc - min(AICc)) %>%
  
  arrange(delta)
```

# 4. Combine all models into a bigass table

```{r}
all_models <- bind_rows(
  core_models,
  comp_models,
  config_models,
  config_int_models
  ) %>%
  
  mutate(model_name = paste0(model_name, "_", buffer_dist)) %>%
  
  distinct(model_name, .keep_all = TRUE) %>%
  
  mutate(delta = AICc - min(AICc)) %>%

  relocate(model_name, 'scale' = 'buffer_dist', 
           df, logLik, AICc, delta,
           'delta_subsetted' = 'delta_subset', 
           'weight_subsetted' = 'weight')
  
  
  

write_csv(all_models, file = "./data/processed/all_models_scales_aic_with_coefficients.csv")
```






