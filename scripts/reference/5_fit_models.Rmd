---
title: "Fit hare models"
author: "Aidan Brushett"
date: "`r Sys.Date()`"
output: 
  html_document:
    theme: default
    toc: yes
    toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE)
```

------------------------------------------------------------------------

# 0. Before you begin

Aidan Brushett M.Sc. Student University of Victoria\
School of Environmental Studies\
Email: [aidanbrushett\@uvic.ca](aidanbrushett@uvic.ca)

------------------------------------------------------------------------

# 1. Set up workspace

## 1.1. Install packages

If you don't already have the following packages installed, use the code below to install them.

```{r install, eval=FALSE}
list.of.packages <- c("tidyverse", "sf", "ggplot2", "glmmTMB", "rphylopic", "ggeffects", "MuMIn")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
rm(new.packages, list.of.packages)
```

## 1.2. Load libraries

And a couple custom functions that can help with masking issues from package loading:

```{r libraries, message=FALSE, warning=FALSE}
rm(list=ls()) # clear environment

library(tidyverse) # data tidying, visualization, and much more; this will load all tidyverse packages, can see complete list using tidyverse_packages()
library(ggplot2) # pretty plots
#library(sf) # spatial data
library(glmmTMB) # Constructing GLMMs
library(MuMIn) # model selection
library(ggeffects)
library(rphylopic)

# These are functions that can sometimes get masked by other packages. Shouldn't be an issue and could be removed.
select <- dplyr::select
filter <- dplyr::filter
mutate <- dplyr::mutate
summarize <- dplyr::summarize
# Cheeky function that means "not in"
`%nin%` = Negate(`%in%`)
```

# 2. Import data

Import the full data file that we'll use to fit our models.

```{r}
data <- read_csv("./data/processed/all_arrays_proportional_presence_monthly_with_covariates.csv",
                 col_types = cols(array = col_factor(),
                                  site = col_factor(),
                                  .default = col_number())) %>%
  
  # A dirty fix for ACTWS to hopefully pull some results out of my modeling
  rowwise() %>% 
  
  mutate(seismic_250 = seismic_lines_250 + seismic_lines_3D_250,
         seismic_1000 = seismic_lines_1000 + seismic_lines_3D_1000) %>%
  
  ungroup() %>%
  
  mutate_at(
      vars(34:417),  # Select columns by index. Everything after UTM. 
      ~ as.numeric(scale(.))
    ) %>%
  
  filter(array != 'WF')
```

# 3. Fit some models

```{r}
buffer <- 1000
```


Remove any existing models in our environment to keep things tidy before we start:

```{r}
rm(list = ls(pattern="m_"))
```

## Part One: site-level models

Now let's fit some super basic models:

```{r}
m_null <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         1,
                       data = data, family = 'binomial')

m_natural <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_shrub_1000 + 
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000,
                       data = data, family = 'binomial')

m_dist <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         seismic_1000 + 
                         wells_1000,
                       data = data, family = 'binomial')

m_nat_dist <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000 + 
                         wells_1000,
                       data = data, family = 'binomial')

m_nat_dist_rf <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000 + 
                         wells_1000 + 
                           (1|array),
                       data = data, family = 'binomial')
```

Put the models in a list:

```{r}
# All models in a list because I'm lazy and don't want to re-write a ton of code
models <- mget(ls(pattern="m_"))
```

Quick peek at the summaries:

```{r}
# Use purrr to print all summaries. Officially breaking up with for loops now :))
map(models, 
    ~summary(.x))
```

Now let's identify the top model:

```{r}
# Create and look at the AIC table
MuMIn::model.sel(models)
```

Pull out the top model:
```{r}
m_top <- rownames(MuMIn::model.sel(models))[1]
```


## Part Two: Interaction with landscape traits

```{r}
m_disturbance <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000*hf_landscape_1000 + 
                         wells_1000*hf_landscape_1000,
                       data = data, family = 'binomial')

m_disturbance_rf <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000*hf_landscape_1000 + 
                         wells_1000*hf_landscape_1000 + 
                           (1|array),
                       data = data, family = 'binomial')

m_lynx <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000*lynx_landscape + 
                         wells_1000*lynx_landscape,
                       data = data, family = 'binomial')

m_lynx_rf <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000*lynx_landscape + 
                         wells_1000*lynx_landscape + 
                         (1|array),
                       data = data, family = 'binomial')

m_coyote <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000*coyote_landscape + 
                         wells_1000*coyote_landscape,
                       data = data, family = 'binomial') 

m_coyote_rf <- glmmTMB::glmmTMB(cbind(snowshoe_hare, absent_snowshoe_hare) ~
                         lc_mixed_1000 +
                         lc_coniferous_1000 + 
                         lc_broadleaf_1000 + 
                         seismic_1000*coyote_landscape + 
                         wells_1000*coyote_landscape + 
                         (1|array),
                       data = data, family = 'binomial') 
```

```{r}
# Create and look at the AIC table
MuMIn::model.sel(m_nat_dist, m_disturbance, m_disturbance_rf, m_nat_dist_rf)
```

```{r}
# Create and look at the AIC table
MuMIn::model.sel(m_nat_dist, m_lynx, m_lynx_rf, m_nat_dist_rf)

MuMIn::model.sel(m_nat_dist, m_lynx)

summary(m_lynx)
```

```{r}
# Create and look at the AIC table
MuMIn::model.sel(m_nat_dist, m_coyote, m_coyote_rf, m_nat_dist_rf)
```

It looks like interaction models come out on top for every single type of interaction.  

```{r}
summary(m_lynx)
```

```{r}
summary(m_disturbance)
```


```{r}
top_model <- m_lynx

summary <- as_tibble(summary(top_model)$coefficients$cond) %>%
  
  mutate(covariate = rownames(summary(top_model)$coefficients$cond))


confint <- top_model %>%   # extract the coefficients and upper and lower CI
  
      confint() %>% 
 
      # format resulting object as a tibble data frame
      as_tibble() %>%
  
      mutate(covariate = rownames(summary(top_model)$coefficients$cond))
```


```{r}
preds <- ggeffects::ggpredict(m_disturbance, terms = c("wells_1000 [all]", paste0("hf_landscape_1000 [",
                                                                              quantile(data$hf_landscape_1000, 0.80),
                                                                              ", ",
                                                                              quantile(data$hf_landscape_1000, 0.20),
                                                                              "]"))) %>%
                                                                          
  ggplot(., aes(x = x, y = predicted, color = group)) +
    geom_line(size = 0.5) +  # Set lines to black
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.4, color = NA) +
    scale_color_manual(values = c('grey30', 'grey30'), labels = c("20% quantile", "80% quantile")) +  # Keep all lines black
    scale_fill_manual(values = c('dodgerblue4', 'darkorange3'), labels = c("20% quantile", "80% quantile")) +  # Set colors for ribbons
    labs(x = "well pads", 
         y = "probability of hare occurrence",
         color = "landscape disturbance", fill = "landscape disturbance") +
    scale_x_continuous(expand = c(0, 0)) +  # Remove left blank space
    theme_minimal() + 
    theme(panel.grid = element_blank(),
          axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
          axis.line.y = element_line(size = 0.5, linetype = "solid", colour = "black"))

preds  
  
ggsave("./figures/wells_landscapedisturbance_interaction.png", plot=preds, dpi=400, width = 7, height = 3)
```


```{r}
preds <- ggeffects::ggpredict(m_lynx, terms = c("seismic_1000 [all]", paste0("lynx_landscape [",
                                                                              quantile(data$lynx_landscape, 0.80),
                                                                              ", ",
                                                                              quantile(data$lynx_landscape, 0.20),
                                                                              "]"))) %>%
                                                                          
  ggplot(., aes(x = x, y = predicted, color = group)) +
    geom_line(size = 0.5) +  # Set lines to black
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.4, color = NA) +
    scale_color_manual(values = c('grey30', 'grey30'), labels = c("20% quantile", "80% quantile")) +  # Keep all lines black
    scale_fill_manual(values = c('dodgerblue4', 'maroon3'), labels = c("20% quantile", "80% quantile")) +  # Set colors for ribbons
    labs(x = "seismic lines", 
         y = "probability of hare occurrence",
         color = "lynx abundance", fill = "lynx abundance") +
    scale_x_continuous(expand = c(0, 0)) +  # Remove left blank space
    theme_minimal() + 
    theme(panel.grid = element_blank(),
          axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
          axis.line.y = element_line(size = 0.5, linetype = "solid", colour = "black"))

preds  
  
ggsave("./figures/lynx_seismic_interaction.png", plot=preds, dpi=400, width = 7, height = 3)
```


```{r}
preds <- ggeffects::ggpredict(m_lynx, terms = c("wells_1000 [all]", paste0("lynx_landscape [",
                                                                              quantile(data$lynx_landscape, 0.80),
                                                                              ", ",
                                                                              quantile(data$lynx_landscape, 0.20),
                                                                              "]"))) %>%
                                                                          
  ggplot(., aes(x = x, y = predicted, color = group)) +
    geom_line(size = 0.5) +  # Set lines to black
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high, fill = group), alpha = 0.4, color = NA) +
    scale_color_manual(values = c('grey30', 'grey30'), labels = c("20% quantile", "80% quantile")) +  # Keep all lines black
    scale_fill_manual(values = c('dodgerblue4', 'maroon3'), labels = c("20% quantile", "80% quantile")) +  # Set colors for ribbons
    labs(x = "seismic lines", 
         y = "probability of hare occurrence",
         color = "lynx abundance", fill = "lynx abundance") +
    scale_x_continuous(expand = c(0, 0)) +  # Remove left blank space
    theme_minimal() + 
    theme(panel.grid = element_blank(),
          axis.line.x = element_line(size = 0.5, linetype = "solid", colour = "black"),
          axis.line.y = element_line(size = 0.5, linetype = "solid", colour = "black"))

preds  
  
ggsave("./figures/lynx_wells_interaction.png", plot=preds, dpi=400, width = 7, height = 3)
```
















